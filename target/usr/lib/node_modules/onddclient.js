(function (fs, dgram) {

class onddListener {

    constructor (socketPath) {
        this.socketPath = socketPath;
        this.dataStore = {};
        this.socket = null;
        this.statusCallback = null;
    }

    setStatusCallback (cb) {
        this.statusCallback  = cb;
    }

    getStatus() {
        return this.dataStore;
    }

    _onData(d) {
        var ds = d.toString();
        try {
            var j = JSON.parse(ds);
            for(var k of Object.keys(j)) {
                this.dataStore[k] = j[k];
            }
            if (this.statusCallback)
                this.statusCallback(this.dataStore);
            } catch(err) {
            }
    }

    start() {

        if (fs.existsSync(this.socketPath))  fs.unlinkSync(this.socketPath);

	this.socket = dgram.createSocket('unix_dgram', this._onData.bind(this));

        this.socket.bind(this.socketPath);
    }

}

module.exports.listener = onddListener;

})(require('fs'), require('unix-dgram'));
